<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<link rel="stylesheet" href="../../lib/weui.min.css"/>
		<link rel="stylesheet" href="../../css/jquery-weui.min.css" />
		<link rel="stylesheet" href="../../css/local.css" />
		<title>支付页面</title>
	</head>
	<body>
		
		<script type="text/javascript" src="../../lib/jquery-2.1.4.js"></script>
		<script type="text/javascript" src="../../js/jquery-weui.js"></script>
		<script src="../../lib/fastclick.js"></script>
		<script src="../../js/cyptojs/rollups/aes.js"></script>
		<script src="../../js/cyptojs/components/pad-zeropadding-min.js"></script>
		<script src="../../js/local.js"></script>
		
		<script>
			function GetQueryString(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg); //search,查询？后面的参数，并匹配正则
				if (r != null) return decodeURI(r[2]);
				return null;
			}
			
			function onBridgeReady(){
					var appId = GetQueryString('appId');
					var nonceStr = GetQueryString('nonceStr');
					var pack = GetQueryString('pack');
					var paySign = GetQueryString('paySign');
					var timestamp = GetQueryString('timeStamp');
					console.log(dcrypt(appId)+"  "+timestamp+"   "+dcrypt(nonceStr)+"    "+dcrypt(pack)+"   "+dcrypt(paySign));
				   WeixinJSBridge.invoke(
				      'getBrandWCPayRequest', {
				         "appId":dcrypt(appId),     //公众号名称，由商户传入     
				         "timeStamp":dcrypt(timestamp),         //时间戳，自1970年以来的秒数     
				         "nonceStr":dcrypt(nonceStr), //随机串     
				         "package":dcrypt(pack),     
				         "signType":"MD5",         //微信签名方式：     
				         "paySign":dcrypt(paySign) //微信签名 
				      },
				      function(res){
				      if(res.err_msg == "get_brand_wcpay_request:ok" ){
				      	location.href="../../../WXOrderSystem/pages/notice/noticeSuccess.html"
				      } 
				      if(res.err_msg == "get_brand_wcpay_request:cancel" ){
				      	$.toast("取消支付", "forbidden");
				      	location.href="../../../WXOrderSystem/main.html"
				      } 
				      if(res.err_msg == "get_brand_wcpay_request:fail" ){
				      	$.toast("支付失败", "forbidden");
				      	location.href="../../../WXOrderSystem/main.html"
				      } 
				   }); 
				}
			
			$().ready(function(){
				$.toptip('下单成功，请在5分钟内完成支付', 3600000, 'success');
				//吊起支付控件
				if (typeof WeixinJSBridge == "undefined"){
				   if( document.addEventListener ){
				       document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
				   }else if (document.attachEvent){
				       document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
				       document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
				   }
				}else{
				   onBridgeReady();
				}
			});
			
			
		</script>
	</body>
</html>
